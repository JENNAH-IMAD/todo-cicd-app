# .github/workflows/ci-cd.yml
# Pipeline CI/CD avec versioning automatique

name: CI/CD Pipeline avec Versioning

# ============================================
# DÃ‰CLENCHEURS (Triggers)
# ============================================
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# ============================================
# VARIABLES D'ENVIRONNEMENT GLOBALES
# ============================================
env:
  DOCKER_USERNAME: bluekayn11
  IMAGE_NAME: todocicd
  PORT: 8060  # âœ… CHANGEMENT ICI

# ============================================
# JOBS (TÃ¢ches du pipeline)
# ============================================
jobs:
  
  # ==========================================
  # JOB 1 : TESTS
  # ==========================================
  test:
    name: Tests Unitaires
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Installer les dÃ©pendances
        run: npm ci
      
      - name: ExÃ©cuter les tests
        run: npm test -- --coverage --watchAll=false
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  # ==========================================
  # JOB 2 : BUILD AVEC VERSIONING
  # ==========================================
  build:
    name: Build Docker avec Versioning
    needs: test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # Lire la version actuelle
      - name: Lire la version actuelle
        id: read_version
        run: |
          if [ -f version.txt ]; then
            CURRENT_VERSION=$(cat version.txt)
          else
            CURRENT_VERSION=0
          fi
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "âœ“ Version actuelle: V$CURRENT_VERSION"
      
      # IncrÃ©menter la version
      - name: IncrÃ©menter la version
        id: increment_version
        run: |
          CURRENT_VERSION=${{ steps.read_version.outputs.current_version }}
          NEW_VERSION=$((CURRENT_VERSION + 1))
          echo $NEW_VERSION > version.txt
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "âœ“ Nouvelle version: V$NEW_VERSION"
      
      # Commit et push de la nouvelle version
      - name: Commit de la nouvelle version
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add version.txt
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ”– Version bump to V${{ steps.increment_version.outputs.new_version }}"
          git push || echo "Nothing to push"
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login vers Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      # âœ… CHANGEMENT ICI : Format du tag
      - name: Build et Push de l'image versionnÃ©e
        uses: docker/build-push-action@v4
        with:
          context: .
          push: ${{ github.ref == 'refs/heads/main' }}
          tags: |
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:v${{ steps.increment_version.outputs.new_version }}
            ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          labels: |
            version=v${{ steps.increment_version.outputs.new_version }}
            commit=${{ github.sha }}
            maintainer=jennahi690@gmail.com
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      # Afficher le rÃ©sumÃ©
      - name: RÃ©sumÃ© du build
        run: |
          echo "ğŸ‰ Build terminÃ© avec succÃ¨s !"
          echo "ğŸ“¦ Image: ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:v${{ steps.increment_version.outputs.new_version }}"
          echo "ğŸ”– Version: V${{ steps.increment_version.outputs.new_version }}"
          echo "ğŸ”Œ Port: ${{ env.PORT }}"
      
      # CrÃ©er un tag Git
      - name: CrÃ©er un tag Git
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          git tag v${{ steps.increment_version.outputs.new_version }} || echo "Tag already exists"
          git push origin v${{ steps.increment_version.outputs.new_version }} || echo "Tag already pushed"

  # ==========================================
  # JOB 3 : DÃ‰PLOIEMENT
  # ==========================================
  deploy:
    name: DÃ©ploiement
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v3
      
      - name: Lire la version
        id: get_version
        run: |
          VERSION=$(cat version.txt)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Afficher les informations de dÃ©ploiement
        run: |
          echo "========================================"
          echo "ğŸš€ DÃ‰PLOIEMENT RÃ‰USSI"
          echo "========================================"
          echo "ğŸ“¦ Image Docker Hub:"
          echo "   bluekayn11/todocicd:v${{ steps.get_version.outputs.version }}"
          echo ""
          echo "ğŸ”– Version: V${{ steps.get_version.outputs.version }}"
          echo "ğŸ”Œ Port: 8060"
          echo ""
          echo "ğŸ“ Pour dÃ©ployer localement:"
          echo "   docker pull bluekayn11/todocicd:v${{ steps.get_version.outputs.version }}"
          echo "   docker run -d -p 8060:80 --name todo-app bluekayn11/todocicd:v${{ steps.get_version.outputs.version }}"
          echo ""
          echo "ğŸŒ URL: http://localhost:8060"
          echo "========================================="